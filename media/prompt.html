<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoEnv</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
  darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              500: '#6366f1',
              600: '#4f46e5',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div class="max-w-6xl mx-auto p-4">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div>
        <h2 class="text-2xl font-semibold mb-3">Rocketize ðŸš€</h2>
        <div id="buttons-list" class="grid grid-cols-3 gap-4"></div>
        <!-- Add Button (Floating +) -->
        <button id="open-modal-btn" class="fixed bottom-8 right-8 z-50 rounded-full bg-primary-600 hover:bg-primary-500 text-white w-14 h-14 flex items-center justify-center shadow-lg text-3xl focus:outline-none" title="Create Button">
            +
        </button>

        <!-- Modal Overlay -->
        <div id="create-modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>

        <!-- Modal Dialog -->
        <div id="create-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="rounded-lg border border-gray-200 dark:border-gray-700 shadow-lg p-6 bg-white dark:bg-gray-800 w-full max-w-md relative">
              <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 dark:text-gray-200 dark:hover:text-white text-2xl focus:outline-none" title="Close">&times;</button>
              <h4 class="text-lg font-semibold mb-2">Create a Button</h4>
              <label for="btn-name" class="block text-sm font-medium mb-1">Name</label>
              <input type="text" id="btn-name" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="E.g., FastAPI, React App" />
              <div class="mt-3">
                <button id="btn-add" class="inline-flex items-center gap-2 rounded-md bg-gray-800 hover:bg-gray-700 dark:bg-primary-600 dark:hover:bg-primary-500 text-white px-3 py-2 text-sm">Add Button</button>
              </div>
            </div>
        </div>

        <script>
            // Modal logic
            const openModalBtn = document.getElementById('open-modal-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modal = document.getElementById('create-modal');
            const overlay = document.getElementById('create-modal-overlay');

            function openModal() {
                modal.classList.remove('hidden');
                overlay.classList.remove('hidden');
                document.getElementById('btn-name').focus();
            }
            function closeModal() {
                modal.classList.add('hidden');
                overlay.classList.add('hidden');
            }

            openModalBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);

            // Optional: close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (!modal.classList.contains('hidden') && e.key === 'Escape') closeModal();
            });

            // Move btn-add logic to close modal after add
            document.getElementById('btn-add').addEventListener('click', () => {
                closeModal();
            });
        </script>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    let prefs = [];

    // Render buttons list
    function renderButtons(items = []) {
      const container = document.getElementById('buttons-list');
      if (!Array.isArray(items) || items.length === 0) {
  container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No buttons yet. Create the first one above.</p>';
        return;
      }
      container.innerHTML = items.map(function(b){
        const safeName = String(b.name || '');
  const safeImg = b.img ? '<img class="rounded-md border border-gray-200 dark:border-gray-700 mt-1" src="' + String(b.img) + '" alt="' + safeName + '">' : '';
        const safeText = String(b.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return [
        '<a id=' + b.id + '>',
          '<div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm p-4">',
            safeImg,
            '<div class="flex items-start gap-3">',
              '<div class="flex-1">',
                '<h4 class="text-base font-semibold">' + safeName + '</h4>',
              '</div>',
            '</div>',
            // add X icon to delete button
            '<button class="text-red-500 hover:text-red-700" onclick="deleteButton(' + b.id + ')">X</button>',
          '</div>',
        '</a>'
        ].join('');
      }).join('');
    }

    // Receive data from extension
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (msg && msg.type === 'buttons:data') {
        renderButtons(msg.items || []);
      }

      
    });


    function planFromPrompt(prompt) {
        vscode.postMessage({ type: 'submit', prompt });
    }

    function reqfetchPossiblePreferences(prompt) {
      
      console.log('Requesting preferences for prompt:', prompt);
      return vscode.postMessage({ type: 'fetchPreferences', prompt });
    }

    // Use getButtonByName from buttons.ts via postMessage/request
    function getButtonByName(name) {
      // This function sends a request to the extension to get the button by name.
      // The extension should respond with a message of type 'button:found' and the button data.
      vscode.postMessage({ type: 'button:getByName', name });
      // Since this is async, checkIfReady should be refactored to handle the response in the message event.
      // For now, return null as a placeholder.
      return null;
    }

    function checkIfReady(prompt) {
      // Try to get the button by name (async)
      getButtonByName(prompt);
      // The actual logic should be handled in the message event when 'button:found' is received.
    }

    // Listen for the button:found response from the extension
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (msg && msg.type === 'button:found' && msg.button) {
      const button = msg.button;
      const prompt = button.name;
      let prefs = msg.prefs || [];
      
      console.log('Received button and preferences:', button, typeof(prefs), prefs, prefs.preferences, button && prefs.preferences.length > 0);
      if (button && Object.keys(prefs.preferences).length > 0) {
        // If preferences exist and they are selected, send them, else make them selectable by rendering a dropdown
        console.log('YAY');


        // If button text is not empty, send already builtin prompt
        if (button.text != "") {
          planFromPrompt(button.text);
          console.log('Already saved button:', fullPrompt);
          return;
        } else {

          // HARD PART. DROPDOWN SHITTY THING
          
          
          // iterate though all preferences, then though its options and make a select dropdown with its options
          const container = document.getElementById('buttons-list');
          const buttonElem = container.querySelector(`#b-${button.id}`);
          console.log('found targets', container, buttonElem);
          if (!buttonElem) {
            console.log(buttonElem);
            return;
          }

          
          
          // Create form elements
          const form = document.createElement('form');
          form.className = 'space-y-4';
          button.preferences.forEach((pref, index) => {
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium';
            label.textContent = pref.value;
            const select = document.createElement('select');
            select.className = 'mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500';
           // iterate though pref.value --> options
            const options = pref.value;
            options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt;
              option.textContent = opt;
              select.appendChild(option);
            });
          });
            form.appendChild(label);
            form.appendChild(select);
          
          const submitBtn = document.createElement('button');
          submitBtn.type = 'submit';
          submitBtn.className = 'inline-flex items-center gap-2 rounded-md bg-primary-600 hover:bg-primary-500 text-white px-3 py-2 text-sm';
          submitBtn.textContent = 'Submit';
          form.appendChild(submitBtn);
          // Handle form submission
          form.addEventListener('submit', (e) => {
            e.preventDefault();
            // Update button.preferences based on selected options
            const selects = form.querySelectorAll('select');
            selects.forEach((select, idx) => {
              const selectedValue = select.value;
              button.preferences[idx].saved = true; // Mark as saved
              button.preferences[idx].value = [selectedValue]; // Update value to selected option
            });
            // Send the full prompt with selected preferences
            const selectedPrefs = button.preferences.filter(p => p.saved).map(p => p.value[0]);
            const fullPrompt = `${prompt}\nPreferences: ${selectedPrefs.join(', ')}`;
            planFromPrompt(fullPrompt);
            // Re-render buttons to original state
            renderButtons(msg.allButtons || []);
          });
          buttonElem.appendChild(form);
          return;
        }
      
      } else {
        console.error('this should not happen');
      }
    }
  });
           

  // Delete a button by id (called from onclicks rendered in cards)
  function deleteButton(id) {
    if (!Number.isFinite(Number(id))) return;
    vscode.postMessage({ type: 'buttons:delete', id: Number(id) });
  }

    // Attach click listeners to all button elements with id starting with 'b-'
    function attachButtonListeners() {
        const container = document.getElementById('buttons-list');
        if (!container) return;
        const buttons = container.querySelectorAll('[id^="b-"]');
        buttons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                // Prevent triggering on delete button
                if (e.target.tagName === 'BUTTON') return;
                const prompt = btn.getAttribute('data-prompt');
                // if (prompt) planFromPrompt(prompt);
                if (prompt) checkIfReady(prompt);
            });
        });
    }

    // Patch renderButtons to include data-prompt and call attachButtonListeners
    const origRenderButtons = renderButtons;
    renderButtons = function(items = []) {
        const container = document.getElementById('buttons-list');
        if (!Array.isArray(items) || items.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No buttons yet. Create the first one above.</p>';
            return;
        }

          // TODO REMOVE THIS: Use default buttons if items is empty
            items = [
          {
              id: 1,
              name: 'FastAPI',
              img: 'https://fastapi.tiangolo.com/img/logo-margin/logo-teal.png',
              text: 'Create a FastAPI project: A modern, fast (high-performance) web framework for building APIs with Python 3.7+ based on standard Python type hints.',
          },
          {
              id: 2,
              name: 'Flask',
              img: 'https://i.ibb.co/0R0BWcyP/image-psd-1.png',
              text: 'Create a Flask project: A lightweight WSGI web application framework in Python, ideal for simple web apps and APIs.',
          },
          {
              id: 3,
              name: 'React App',
              img: 'https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg',
              text: 'Create a React project: A JavaScript library for building user interfaces, commonly used for single-page applications.',
          },
            ];
        

        container.innerHTML = items.map(function(b){
            const safeName = String(b.name || '');
            const safeImg = b.img ? '<img class="rounded-md border border-gray-200 dark:border-gray-700 mt-1" src="' + String(b.img) + '" alt="' + safeName + '">' : '';
            const safeText = String(b.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            // Use id 'b-' + b.id and store prompt in data-prompt
            return [
                '<a id="b-' + b.id + '" data-prompt="' + (b.prompt ? String(b.prompt).replace(/"/g, '&quot;') : safeText) + '">',
                    '<div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm p-4">',
                        safeImg,
                        '<div class="flex items-start gap-3">',
                            '<div class="flex-1">',
                                '<h4 class="text-base font-semibold">' + safeName + '</h4>',
                            '</div>',
                        '</div>',
                        '<button class="text-red-500 hover:text-red-700" onclick="deleteButton(' + b.id + ')">X</button>',
                    '</div>',
                '</a>'
            ].join('');
        }).join('');
        attachButtonListeners();
    };

    // Form: create button
    document.getElementById('btn-add').addEventListener('click', () => {
      const name = String(document.getElementById('btn-name').value || '').trim();
      if (!name) {
        alert('Please provide a name');
        return;
      }
      
      let img = '';
      let text = '';
      
      
      // debugger;
      

      reqfetchPossiblePreferences(name);

      vscode.postMessage({ type: 'buttons:create', data: { name, img, text, preferences: [] } });
      document.getElementById('btn-name').value = '';
    });
    // });

    // On load: request list
    vscode.postMessage({ type: 'buttons:list' });
  </script>
  <script>
    // Map VS Code webview theme to Tailwind dark mode
    function applyVscodeTheme() {
      const isDark = document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast');
      document.documentElement.classList.toggle('dark', isDark);
    }
    applyVscodeTheme();
    const mo = new MutationObserver(applyVscodeTheme);
    mo.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  </script>
</body>
</html>
