<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoEnv</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
  darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              500: '#6366f1',
              600: '#4f46e5',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div class="max-w-6xl mx-auto p-4">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div>
        <h2 class="text-2xl font-semibold mb-3">Rocketize ðŸš€</h2>
        <div id="buttons-list" class="grid grid-cols-3 gap-4"></div>
        <!-- Add Button (Floating +) -->
        <button id="open-modal-btn" class="fixed bottom-8 right-8 z-50 rounded-full bg-primary-600 hover:bg-primary-500 text-white w-14 h-14 flex items-center justify-center shadow-lg text-3xl focus:outline-none" title="Create Button">
            +
        </button>

        <!-- Modal Overlay -->
        <div id="create-modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>

        <!-- Modal Dialog -->
        <div id="create-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="rounded-lg border border-gray-200 dark:border-gray-700 shadow-lg p-6 bg-white dark:bg-gray-800 w-full max-w-md relative">
              <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 dark:text-gray-200 dark:hover:text-white text-2xl focus:outline-none" title="Close">&times;</button>
              <h4 class="text-lg font-semibold mb-2">Create a Button</h4>
              <label for="btn-name" class="block text-sm font-medium mb-1">Name</label>
              <input type="text" id="btn-name" class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="E.g., FastAPI, React App" />
              <div class="mt-3">
                <button id="btn-add" class="inline-flex items-center gap-2 rounded-md bg-gray-800 hover:bg-gray-700 dark:bg-primary-600 dark:hover:bg-primary-500 text-white px-3 py-2 text-sm">Add Button</button>
              </div>
            </div>
        </div>

        <script>
            // Modal logic
            const openModalBtn = document.getElementById('open-modal-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modal = document.getElementById('create-modal');
            const overlay = document.getElementById('create-modal-overlay');

            function openModal() {
                modal.classList.remove('hidden');
                overlay.classList.remove('hidden');
                document.getElementById('btn-name').focus();
            }
            function closeModal() {
                modal.classList.add('hidden');
                overlay.classList.add('hidden');
            }

            openModalBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);

            // Optional: close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (!modal.classList.contains('hidden') && e.key === 'Escape') closeModal();
            });

            // Move btn-add logic to close modal after add
            document.getElementById('btn-add').addEventListener('click', () => {
                closeModal();
            });
        </script>
      </div>
    </div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

  let prefs = [];
  // cache preferences by button id and track when to show immediately after fetch
  const prefsCache = {};
  let pendingShowId = null;

    // Render buttons list
    function renderButtons(items = []) {
      const container = document.getElementById('buttons-list');
      if (!Array.isArray(items) || items.length === 0) {
  container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No buttons yet. Create the first one above.</p>';
        return;
      }
      container.innerHTML = items.map(function(b){
        const safeName = String(b.name || '');
  const safeImg = b.img ? '<img class="rounded-md border border-gray-200 dark:border-gray-700 mt-1" src="' + String(b.img) + '" alt="' + safeName + '">' : '';
        const safeText = String(b.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return [
        '<div id=' + b.id + ' class="cursor-pointer select-none">',
          '<div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm p-4">',
            safeImg,
            '<div class="flex items-start gap-3">',
              '<div class="flex-1">',
                '<h4 class="text-base font-semibold">' + safeName + '</h4>',
              '</div>',
            '</div>',
            // add X icon to delete button
            '<button class="text-red-500 hover:text-red-700" onclick="deleteButton(' + b.id + ')">X</button>',
          '</div>',
        '</div>'
        ].join('');
      }).join('');
    }

    // Receive data from extension
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (msg && msg.type === 'buttons:data') {
        renderButtons(msg.items || []);
      }
      if (msg && msg.type === 'preferences:prepared') {
        // cache prepared preferences for later use
        if (msg && typeof msg.id === 'number') {
          prefsCache[msg.id] = msg.prefs || null;
        }
      }

      
    });


    function planFromPrompt(prompt) {
        vscode.postMessage({ type: 'submit', prompt });
    }

    function reqfetchPossiblePreferences(prompt) {
      
      console.log('Requesting preferences for prompt:', prompt);
      return vscode.postMessage({ type: 'fetchPreferences', prompt });
    }

    // Use getButtonByName from buttons.ts via postMessage/request
    function getButtonByName(name) {
      // This function sends a request to the extension to get the button by name.
      // The extension should respond with a message of type 'button:found' and the button data.
      vscode.postMessage({ type: 'button:getByName', name });
      // Since this is async, checkIfReady should be refactored to handle the response in the message event.
      // For now, return null as a placeholder.
      return null;
    }

    function checkIfReady(prompt) {
      // Try to get the button by name (async)
      getButtonByName(prompt);
      // The actual logic should be handled in the message event when 'button:found' is received.
    }

    // Listen for the button:found response from the extension
    window.addEventListener('message', (event) => {
      const msg = event.data;
  if (msg && msg.type === 'button:found' && msg.button) {
      const button = msg.button;
      const prompt = button.name;
      let prefs = msg.prefs || [];
      
      console.log('Received button and preferences:', button, typeof(prefs), prefs, prefs.preferences, button && prefs.preferences.length > 0);
  if (button && prefs && prefs.preferences && Object.keys(prefs.preferences).length > 0) {
        // If preferences exist and they are selected, send them, else make them selectable by rendering a dropdown
        console.log('YAY');
          button.img  = prefs.imageUrl;

        // If button text is not empty, send already builtin prompt
        if (button.text != "") {
          planFromPrompt(button.text);
          console.log('Already saved button:', button.text);
          return;
        } else {

          // HARD PART. DROPDOWN SHITTY THING
          
          
          // Use the existing card for this button
          const container = document.getElementById('buttons-list');
          const buttonElem = container.querySelector(`#b-${button.id}`);
          console.log('found targets', container, buttonElem);
          if (!buttonElem) {
            console.log('Button element not found for id', button.id);
            return;
          }

          // Create form elements (hidden by default; shown when user requested)
          const form = document.createElement('form');
          form.className = 'space-y-4 hidden';
          // prefs.preferences is an object map: { category: string[] }
          const prefEntries = Object.entries(prefs.preferences || {});
          prefEntries.forEach(([category, options], index) => {
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium';
            label.textContent = category || `Preference ${index + 1}`;
            const select = document.createElement('select');
            select.className = 'mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100';
            const optsArr = Array.isArray(options) ? options : [];
            optsArr.forEach(opt => {
              const option = document.createElement('option');
              option.value = String(opt);
              option.textContent = String(opt);
              select.appendChild(option);
            });
            form.appendChild(label);
            form.appendChild(select);
          });
          // Actions: Run and Run & Save
          const actions = document.createElement('div');
          actions.className = 'flex gap-2 pt-2';
          const runBtn = document.createElement('button');
          runBtn.type = 'button';
          runBtn.className = 'inline-flex items-center gap-2 rounded-md bg-primary-600 hover:bg-primary-500 text-white px-3 py-2 text-sm';
          runBtn.textContent = 'Run';
          const runSaveBtn = document.createElement('button');
          runSaveBtn.type = 'button';
          runSaveBtn.className = 'inline-flex items-center gap-2 rounded-md bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 text-sm';
          runSaveBtn.textContent = 'Run & Save';
          actions.appendChild(runBtn);
          actions.appendChild(runSaveBtn);
          form.appendChild(actions);
          // Handle Run
          runBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const selects = Array.from(form.querySelectorAll('select'));
            const selectedPrefs = selects.map((select) => /** @type {HTMLSelectElement} */(select).value);
            const fullPrompt = `${prompt}\nPreferences: ${selectedPrefs.join(', ')}`;
            form.classList.add('hidden');
            planFromPrompt(fullPrompt);
          });
          // Handle Run & Save
          runSaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const selects = Array.from(form.querySelectorAll('select'));
            const selectedPrefs = selects.map((select) => /** @type {HTMLSelectElement} */(select).value);
            const fullPrompt = `${prompt}\nPreferences: ${selectedPrefs.join(', ')}`;
            vscode.postMessage({ type: 'button:saveText', id: button.id, text: fullPrompt });
            form.classList.add('hidden');
            planFromPrompt(fullPrompt);
          });
          buttonElem.appendChild(form);
          // If this was requested by a card click, show now
          const idStr = buttonElem.getAttribute('id') || '';
          const id = Number(idStr.replace('b-',''));
          if (Number.isFinite(id) && pendingShowId === id) {
            form.classList.remove('hidden');
            pendingShowId = null;
          }
          return;
        }
      
      } else {
        console.error('this should not happen');
      }
    }
  });
           

  // Delete a button by id (called from onclicks rendered in cards)
  function deleteButton(id) {
    if (!Number.isFinite(Number(id))) return;
    vscode.postMessage({ type: 'buttons:delete', id: Number(id) });
  }

    // Attach click listeners to all button elements with id starting with 'b-'
    function attachButtonListeners() {
        const container = document.getElementById('buttons-list');
        if (!container) return;
        const buttons = container.querySelectorAll('[id^="b-"]');
        buttons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                // Prevent triggering on delete button
                if (e.target.tagName === 'BUTTON') return;
                // If form exists, just show it
                const existingForm = btn.querySelector('form');
                if (existingForm) {
                  existingForm.classList.remove('hidden');
                  return;
                }
                const idStr = btn.getAttribute('id') || '';
                const id = Number(idStr.replace('b-',''));
                const name = btn.getAttribute('data-name') || '';
                if (Number.isFinite(id) && prefsCache[id]) {
                  // Build and show immediately from cache
                  const fakeMsg = { button: { id, name, text: '' }, prefs: prefsCache[id] };
                  // Simulate the existing handler path
                  window.postMessage({ type: 'button:found', ...fakeMsg }, '*');
                  pendingShowId = id;
                } else if (name) {
                  pendingShowId = Number.isFinite(id) ? id : null;
                  reqfetchPossiblePreferences(name);
                }
            });
        });
    }

    // Patch renderButtons to include data-prompt and call attachButtonListeners
    const origRenderButtons = renderButtons;
    renderButtons = function(items = []) {
        const container = document.getElementById('buttons-list');
        if (!Array.isArray(items) || items.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No buttons yet. Create the first one above.</p>';
            return;
        }

  // Use provided items as-is

        container.innerHTML = items.map(function(b){
            const safeName = String(b.name || '');
            const safeImg = b.img ? '<img class="rounded-md border border-gray-200 dark:border-gray-700 mt-1" src="' + String(b.img) + '" alt="' + safeName + '">' : '';
            const safeText = String(b.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            // Use id 'b-' + b.id and store prompt in data-prompt
      return [
        '<div id="b-' + b.id + '" role="button" tabindex="0" class="cursor-pointer select-none" data-name="' + safeName.replace(/\"/g, '&quot;') + '" data-prompt="' + (b.prompt ? String(b.prompt).replace(/\"/g, '&quot;') : safeText) + '">',
          '<div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm p-4">',
            safeImg,
            '<div class="flex items-start gap-3">',
              '<div class="flex-1">',
                '<h4 class="text-base font-semibold">' + safeName + '</h4>',
              '</div>',
            '</div>',
            '<button class="text-red-500 hover:text-red-700" onclick="deleteButton(' + b.id + ')">X</button>',
          '</div>',
        '</div>'
      ].join('');
        }).join('');
        attachButtonListeners();
    };

    // Form: create button
  document.getElementById('btn-add').addEventListener('click', () => {
      const name = String(document.getElementById('btn-name').value || '').trim();
      if (!name) {
        alert('Please provide a name');
        return;
      }
      
      let img = '';
      let text = '';
      
      
      // debugger;

      vscode.postMessage({ type: 'buttons:create', data: { name, img, text, preferences: [] } });
      document.getElementById('btn-name').value = '';
    });
    // });

    // On load: request list
    vscode.postMessage({ type: 'buttons:list' });
  </script>
  <script>
    // Map VS Code webview theme to Tailwind dark mode
    function applyVscodeTheme() {
      const isDark = document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast');
      document.documentElement.classList.toggle('dark', isDark);
    }
    applyVscodeTheme();
    const mo = new MutationObserver(applyVscodeTheme);
    mo.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  </script>
</body>
</html>
